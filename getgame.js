const _AUTHOR='Gregory Maynard-Hoare';import{Archive}from './libarchive.js';async function getGame(){const isLQ=Window.qIsLQ;const pCB=Window.qProgressCallback;const event=new Event('userEventPAKReady');Window.qPAKData=null;try{let dlFile,dlURL,dlTitle;if(isLQ){dlFile='lq';dlURL=dlFile;dlTitle='Downloading LibreQuake...';}else{dlFile='quake106.zip';dlURL='https://gmh-code.github.io/quake/'+dlFile;dlTitle='Downloading official '+dlFile+'...';}
pCB(dlTitle);const zXHR=new XMLHttpRequest();zXHR.open('GET',dlURL,true);zXHR.responseType='blob';zXHR.onprogress=function(event){if(event.lengthComputable){pCB(dlTitle+' ('+event.loaded+'/'+event.total+')');}};zXHR.onload=async function(){if(zXHR.status===200){const zBlob=new Blob([zXHR.response],{type:zXHR.getResponseHeader('Content-Type')});const zFile=new File([zBlob],'a.zip');let PAKData={};if(isLQ){pCB('Opening LibreQuake archive...');const zArc=await Archive.open(zFile);pCB('Reading archive contents...');const zFilesObj=await zArc.getFilesObject();for(let i=0;i<6;i++){pCB('Unpacking file '+(i+1)+' of 6...');const pakName='pak'+i+'.pak';const pFile=await zFilesObj[pakName].extract();const pArrayBuf=await pFile.arrayBuffer();PAKData[pakName]=new Uint8Array(pArrayBuf);}
await zArc.close();}else{pCB('Opening quake106.zip...');const zArc=await Archive.open(zFile);pCB('Reading ZIP contents...');const zFilesObj=await zArc.getFilesObject();pCB('Extracting resource.1 file from ZIP file...');const rFile=await zFilesObj['resource.1'].extract();pCB('Opening LHA-format resource.1 file...');const rArc=await Archive.open(rFile);pCB('Reading LHA-format resource.1 contents...');const rFilesObj=await rArc.getFilesObject();pCB('Extracting PAK0.PAK from LHA-format file...');const pFile=await rFilesObj['ID1']['PAK0.PAK'].extract();pCB('Reading PAK0.PAK...');await rArc.close();await zArc.close();const pArrayBuf=await pFile.arrayBuffer();PAKData['pak0.pak']=new Uint8Array(pArrayBuf);}
Window.qPAKData=PAKData;}else{console.warn('File fetch response was not OK.');}
window.dispatchEvent(event);};zXHR.onerror=async function(){console.error('An error occurred while downloading the file');window.dispatchEvent(event);};zXHR.send();}catch(error){console.warn('Operation error:',error);window.dispatchEvent(event);}}
getGame();